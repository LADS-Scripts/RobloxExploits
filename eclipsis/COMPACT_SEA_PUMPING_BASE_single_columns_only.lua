names = {'Submersible','Slab Block','Four-Way','Pipe','Cap','Distributor','Fabricator','Distributor Cap','Automechanic','Shield Generator','Point Defense','T-Junction','Reservoir','Elbow',};
attachments = {'FemaleFlange','FemaleFlange3','FemaleFlange2','FemaleFlange1','FemaleFlange4',};
local n
local cf = function(xp, yp, zp, xr, yr, zr)
	return cfn(xp, yp, zp)*cfa(xr,yr,zr)
end
cfn, cfa = CFrame.new, CFrame.fromEulerAnglesYXZ
local tbl = {
{1,cf(-0.03,0.65,3.58,-0,0,0),0,n,n,n,n},{1,cf(3.62,0.65,5.705,-0,0,0),0,n,n,n,n},{2,cf(5.645,-0.5,-11.665,0,-1.57,-0),0,n,n,n,n},{3,cf(-0.8,-2.1,0,1.57,1.57,0),1,1,1,2,n},{2,cf(-5.41,11.33,-11.765,1.57,-1.57,0),0,n,n,n,n},{2,cf(5.38,11.05,-11.655,1.57,1.57,0),0,n,n,n,n},{4,cf(0,0,0,-0,0,0),2,4,2,3,1},{3,cf(0,-2.1,0.8,1.57,3.14,0),1,4,4,2,n},{5,cf(0,-0.4,0.6,-1.57,-0,0),1,4,8,n,n},{6,cf(-4.03,0.55,-15.025,-0,0,0),0,n,n,n,n},{4,cf(0,0,0,-0,0,0),2,10,8,1,5},{7,cf(-6.16,2.72,-5.845,0,3.14,-1.57),0,n,n,n,n},{8,cf(-0.6,-0.4,0,-1.57,-1.57,0),1,1,12,n,n},{1,cf(-3.55,0.65,5.235,-0,0,0),0,n,n,n,n},{4,cf(0,0,0,-0,0,0),2,14,4,1,5},{7,cf(-6.16,7.21,-5.8,-0,-3.14,-1.57),0,n,n,n,n},{8,cf(-0.6,-0.4,0,-1.57,-1.57,0),1,1,16,n,n},{1,cf(0.11,3.03,3.55,-0,0,0),0,n,n,n,n},{3,cf(-0.8,-2.1,0,1.57,1.57,0),1,1,18,2,n},{3,cf(0,-2.1,0.8,1.57,-3.14,0),1,4,19,2,n},{5,cf(-0.155,-0.4,0.58,-1.57,-0.26,0),1,4,20,n,n},{4,cf(0,0,0,-0,0,0),2,8,20,3,3},{1,cf(3.65,3.03,5.59,-0,0,0),0,n,n,n,n},{4,cf(0,0,0,-0,0,0),2,23,19,1,3},{7,cf(6.13,2.515,-6.245,0,3.14,1.57),0,n,n,n,n},{8,cf(-0.6,-0.4,0,-1.57,-1.57,0),1,1,25,n,n},{7,cf(6.13,6.99,-6.22,0,-3.14,1.57),0,n,n,n,n},{8,cf(-0.58,-0.4,-0.155,-1.57,-1.835,0),1,1,27,n,n},{1,cf(-3.575,3.03,5.155,-0,0,0),0,n,n,n,n},{4,cf(0,0,0,-0,0,0),2,29,19,1,5},{7,cf(-6.16,2.63,-10.03,-0,0,1.57),0,n,n,n,n},{8,cf(-0.6,-0.4,0,-1.57,-1.57,0),1,1,31,n,n},{1,cf(0.005,5.41,3.52,-0,-0,0),0,n,n,n,n},{3,cf(-0.8,-2.1,0,1.57,1.57,0),1,1,33,2,n},{3,cf(0,-2.1,0.8,1.57,3.14,0),1,4,34,2,n},{5,cf(0,-0.4,0.6,-1.57,-0,0),1,4,35,n,n},{4,cf(0,0,0,-0,0,0),2,20,35,5,5},{1,cf(3.6,5.41,5.94,-0,-0,0),0,n,n,n,n},{4,cf(0,0,0,-0,0,0),2,38,34,1,3},{1,cf(-3.795,5.41,5.17,-0,0,0),0,n,n,n,n},{4,cf(0,0,0,-0,0,0),2,40,34,1,5},{7,cf(6.13,2.335,-10.465,0,0,-1.57),0,n,n,n,n},{8,cf(-0.52,-0.4,0.3,-1.57,-1.045,0),1,1,42,n,n},{7,cf(6.13,6.65,-10.41,-0,0,-1.57),0,n,n,n,n},{8,cf(-0.58,-0.4,0.155,-1.57,-1.31,0),1,1,44,n,n},{7,cf(-6.16,6.895,-9.98,-0,0,1.57),0,n,n,n,n},{8,cf(-0.58,-0.4,-0.155,-1.57,-1.835,0),1,1,46,n,n},{1,cf(0.105,7.79,3.215,-0,0,0),0,n,n,n,n},{1,cf(3.755,7.79,5.73,-0,-0,0),0,n,n,n,n},{1,cf(-3.73,7.79,5.885,-0,-0,0),0,n,n,n,n},{3,cf(-0.8,-2.1,0,1.57,1.57,0),1,1,48,2,n},{3,cf(0,-2.1,0.8,1.57,3.14,0),1,4,51,2,n},{4,cf(0,0,0,-0,0,0),2,35,52,3,3},{5,cf(-0.3,-0.4,0.52,-1.57,-0.525,0),1,4,52,n,n},{4,cf(0,0,0,-0,0,0),2,51,50,5,1},{4,cf(0,0,0,-0,0,0),2,49,51,1,3},{1,cf(0.2,10.165,3.425,-0,0,0),0,n,n,n,n},{3,cf(-0.8,-2.1,0,1.57,1.57,0),1,1,57,2,n},{3,cf(0,-2.1,0.8,1.57,3.14,0),1,4,58,2,n},{4,cf(0,0,0,-0,0,0),2,52,59,5,5},{5,cf(0,-0.4,0.6,-1.57,-0,0),1,4,59,n,n},{1,cf(3.735,10.165,5.965,-0,0,0),0,n,n,n,n},{4,cf(0,0,0,-0,0,0),2,62,58,1,3},{1,cf(-3.63,10.165,5.75,-0,-0,0),0,n,n,n,n},{4,cf(0,0,0,-0,0,0),2,64,58,1,5},{9,cf(-6.16,7.545,-16.925,-0,0,1.57),0,n,n,n,n},{9,cf(-6.16,1.825,-16.885,-0,-0,1.57),0,n,n,n,n},{8,cf(0,-0.4,-0.6,-1.57,-3.14,0),1,1,67,n,n},{8,cf(0,-0.4,-0.6,-1.57,3.14,0),1,1,66,n,n},{9,cf(6.13,2.26,-17.16,-0,0,-1.57),0,n,n,n,n},{9,cf(6.13,8.13,-17.28,-0,0,-1.57),0,n,n,n,n},{8,cf(-0.52,-0.4,0.3,-1.57,-1.045,0),1,1,70,n,n},{8,cf(-0.52,-0.4,0.3,-1.57,-1.045,0),1,1,71,n,n},{10,cf(-17.56,2.375,-10.4,-0,-0,1.57),0,n,n,n,n},{10,cf(-17.56,7.21,-10.4,-0,-0,1.57),0,n,n,n,n},{10,cf(17.53,1.645,-10.895,0,0,-1.57),0,n,n,n,n},{10,cf(17.53,6.725,-10.935,0,0,-1.57),0,n,n,n,n},{8,cf(-0.58,-0.4,0.155,-1.57,-1.31,0),1,1,76,n,n},{8,cf(-0.58,-0.4,0.155,-1.57,-1.31,0),1,1,77,n,n},{8,cf(-0.3,-0.4,0.52,-1.57,-0.525,0),1,1,74,n,n},{8,cf(-0.3,-0.4,0.52,-1.57,-0.525,0),1,1,75,n,n},{11,cf(-5.89,12.08,-15.455,-0,-3.14,0),0,n,n,n,n},{8,cf(-0.58,-0.4,0.155,-1.57,-1.31,0),1,1,82,n,n},{11,cf(5.8,11.8,-15.295,-0,3.14,-0),0,n,n,n,n},{8,cf(-0.6,-0.4,0,-1.57,-3.14,1.57),1,1,84,n,n},{11,cf(-7.675,7.225,-20.925,-0,1.57,-1.57),0,n,n,n,n},{12,cf(-0.565,-2.1,0.565,1.57,2.355,0),1,1,86,2,n},{8,cf(0.3,-0.4,0.52,-1.57,0.525,0),1,3,87,n,n},{8,cf(-0,-0.4,0.6,-1.57,0,0),1,4,87,n,n},{11,cf(7.565,7.625,-21.28,-0,-1.57,1.57),0,n,n,n,n},{8,cf(-0.425,-0.4,-0.425,-1.57,-2.355,0),1,1,90,n,n},{13,cf(0.115,10.035,8.965,1.57,-0,0),0,n,n,n,n},{4,cf(0.315,14.045,4.625,-0,3.14,0),3,92,1,n,n},{14,cf(0.98,-1,-0.1,0,2.62,-1.57),1,3,59,3,n},{4,cf(0,0,0,-0,0,0),2,94,93,4,3},{9,cf(-10.655,25.135,22.025,0,0,0),0,n,n,n,n},{9,cf(12.31,25.135,21.87,0,0,0),0,n,n,n,n},{8,cf(-0.6,-0.4,0,-1.57,-1.57,0),1,1,96,n,n},{8,cf(-0.6,-0.4,0,-1.57,-1.57,0),1,1,97,n,n},{10,cf(-5.145,25.435,21.96,-0,-3.14,-0),0,n,n,n,n},{10,cf(-0.39,25.435,21.94,-0,-3.14,-0),0,n,n,n,n},{10,cf(4.365,25.435,22.01,-0,-3.14,-0),0,n,n,n,n},{8,cf(-0.6,-0.4,0,-1.57,-1.57,0),1,1,101,n,n},{8,cf(-0.6,-0.4,0,-1.57,-1.57,0),1,1,100,n,n},{8,cf(-0.6,-0.4,0,-1.57,-1.57,0),1,1,102,n,n},{10,cf(-15.745,22.025,22.175,0,3.14,-1.57),0,n,n,n,n},{10,cf(-15.745,16.985,22.18,-0,-3.14,-1.57),0,n,n,n,n},{10,cf(-15.745,12.295,22.195,-0,-3.14,-1.57),0,n,n,n,n},{10,cf(-15.745,7.515,22.21,-0,3.14,-1.57),0,n,n,n,n},{10,cf(-15.745,2.67,22.21,-0,3.14,-1.57),0,n,n,n,n},{10,cf(-15.745,-2.03,22.24,-0,-3.14,-1.57),0,n,n,n,n},{8,cf(-0.6,-0.4,0,-1.57,-1.57,0),1,1,111,n,n},{8,cf(-0.58,-0.4,0.155,-1.57,-1.31,0),1,1,110,n,n},{8,cf(-0.52,-0.4,0.3,-1.57,-1.045,0),1,1,109,n,n},{8,cf(-0.425,-0.4,0.425,-1.57,-0.785,0),1,1,108,n,n},{8,cf(-0.425,-0.4,0.425,-1.57,-0.785,0),1,1,107,n,n},{8,cf(-0.3,-0.4,0.52,-1.57,-0.525,0),1,1,106,n,n},{10,cf(15.505,22.05,22.415,-0,3.14,1.57),0,n,n,n,n},{10,cf(15.505,16.74,22.4,-0,3.14,1.57),0,n,n,n,n},{10,cf(15.505,11.545,22.385,-0,3.14,1.57),0,n,n,n,n},{10,cf(15.505,6.745,22.375,-0,3.14,1.57),0,n,n,n,n},{10,cf(15.505,1.895,22.35,-0,3.14,1.57),0,n,n,n,n},{10,cf(15.505,-3.05,22.31,-0,3.14,1.57),0,n,n,n,n},{8,cf(-0.6,-0.4,0,-1.57,-1.57,0),1,1,123,n,n},{8,cf(-0.6,-0.4,0,-1.57,-1.57,0),1,1,122,n,n},{8,cf(-0.6,-0.4,0,-1.57,-1.57,0),1,1,121,n,n},{8,cf(-0.6,-0.4,0,-1.57,-1.57,0),1,1,120,n,n},{8,cf(-0.6,-0.4,0,-1.57,-1.57,0),1,1,119,n,n},{9,cf(-0.625,19.4,20.245,-0,-1.57,1.31),0,n,n,n,n},{9,cf(-0.25,3.47,19.595,0.01,-1.64,1.825),0,n,n,n,n},{8,cf(-0.58,-0.4,0.155,-1.57,-1.31,0),1,1,129,n,n},{8,cf(-0.58,-0.4,-0.155,-1.57,-1.835,0),1,1,130,n,n},{9,cf(9.355,10.355,20.24,1.505,3.015,0.125),0,n,n,n,n},{9,cf(-9.255,10.415,20.145,1.505,-3.015,-0.125),0,n,n,n,n},{8,cf(-0.58,-0.4,-0.155,-1.57,-1.835,0),1,1,133,n,n},{8,cf(-0.58,-0.4,0.155,-1.57,1.255,0.945),1,1,134,n,n},}
--replace till this line



local import = function(toimport)
	return typeof(toimport) == "number" and game:GetObjects("rbxassetid://" .. toimport)[1] or syn and loadstring(syn.request({Url = toimport}).Body)() or loadstring(game:HttpGetAsync(toimport))()
end



local billboard = import(9184931264)
local remote = game:GetService("ReplicatedStorage").Shared.Remotes.PlaceStructure
local buttonRemote = game:GetService("ReplicatedStorage").Shared.Remotes.ContextButton
local lplr = game:GetService('Players').LocalPlayer
local mouse = lplr:GetMouse()
mouse.Button1Down:Wait()
local base = mouse.Target

local placed = {}
local structures = workspace:WaitForChild('Structures')
local run = game:GetService('RunService')
local buildstart = os.clock()



local partsToFind = {
	UpgradeStation = 'Part';
	Arsenal = 'TeamColor';
	['Point Defense'] = 'TeamColor'
}



local _mmreg = {}
local newline = [[
]]
local mmreg = setmetatable({},{
	__newindex = function(_, i, v)
		_mmreg[i..'min'] = _mmreg[i..'min'] ~= nil and math.min(v-11, _mmreg[i..'min']) or  math.huge
		_mmreg[i..'max'] = _mmreg[i..'max'] ~= nil and math.max(v+11, _mmreg[i..'max']) or -math.huge
	end;
	__index = function(_, i)
		return _mmreg[i]
	end;
	__tostring = function()
		local r = ''
		for i, v in pairs(_mmreg) do
			r..=i..' = '..v..newline
		end
		return r
	end
})

for _, v in ipairs(tbl) do
	local pos = v[2].Position
	mmreg.X = pos.X
	mmreg.Y = pos.Y
	mmreg.Z = pos.Z
end

local mincf = CFrame.new(_mmreg.Xmin,_mmreg.Ymin,_mmreg.Zmin)
local maxcf = CFrame.new(_mmreg.Xmax,_mmreg.Ymax,_mmreg.Zmax)

local p = Instance.new('Part', workspace.CurrentCamera)
p.Anchored = true
p.CanCollide = false
p.CanQuery = false
p.Material = Enum.Material.ForceField
p.Size = Vector3.new(maxcf.X-mincf.X,maxcf.Y-mincf.Y,maxcf.Z-mincf.Z)
p.Color = Color3.new(1,.2, .2)
p.CFrame =base.CFrame* CFrame.new( (maxcf.p+mincf.p)/2 )

print(p.CFrame.Position - workspace.CurrentCamera.CFrame.Position)

billboard.Parent = game.CoreGui
billboard.Adornee = p

local totalParts = #tbl
local hsize = p.Size/2
local partCF = p.CFrame

task.delay(60*10, function()
	game.Debris:AddItem(p, 1)
end)

_rancalls = 0
local ranpos = function()
	_rancalls+=1
	if _rancalls>=10000 then
		_rancalls = math.random(-10000, 1000)
	end

	math.randomseed(_rancalls)
	return Vector3.new(
		math.random(-7000, 7000)
		,math.random(-7000, 7000)
		,math.random(-7000, 7000)
	)/40000
end


function isInsideBrick(position)
	local v3 = partCF:PointToObjectSpace(position)
	return (math.abs(v3.X) <= hsize.X)
		and (math.abs(v3.Y) <= hsize.Y)
		and (math.abs(v3.Z) <= hsize.Z)
end






local shields = {}

local enableShield = function(found)
	local foundClone = found
	if foundClone.Name == 'Shield Generator' then
		coroutine.wrap(function()
			local enabled = shields[foundClone]
			if enabled == nil then
				shields[foundClone] = true
			else
				return
			end
			
			if foundClone:WaitForChild('EnableButton', 5) and foundClone.EnableButton:WaitForChild('ContextButton', 5) then
				task.wait(5)
				buttonRemote:FireServer(foundClone.EnableButton.ContextButton)
			end
		end)()
	end
end

local placeStructure = function(i, v, tries)
	local name = names[v[1]]

	billboard.ProgressTotal.Bar.Size = UDim2.fromScale(i/totalParts, 1)
	billboard.ProgressTotal.TextLabel.Text = tostring( math.round(i/totalParts*100) )..'%     '..i..'/'..totalParts..'     '..math.round(os.clock()-buildstart)..'s'
	--billboard.Structure.TextLabel.Text = name
	billboard.StudsOffset = Vector3.new(0, hsize.Y*1.1+5, 0)

	local placeMode = v[3]
	if placeMode == 0 then
		remote:FireServer(
			name
			,{
				['BasePart'] = base;
				['CFrame'] = v[2] + (tries <5 and Vector3.new() or ranpos()) * (tries < 25 and .1 or i/200 )
			}
		)
	elseif placeMode == 1 then
		local needed = nil
		local s = os.clock()+2
		while needed == nil and os.clock()<s do
			for ii, vv in ipairs(placed[v[5]]:GetDescendants()) do
				if vv:IsA('BasePart') and vv.Name == attachments[ v[4] ] then
					needed = vv
					break
				end
			end
			run.RenderStepped:Wait()
		end
		remote:FireServer(
			name
			,{
				['BasePart'] = needed ;
				['CFrame'] = v[2]
			}
			,attachments[ v[6] or v[4] ]
			,needed
		)
	elseif placeMode == 2 then
		local needed1 = nil
		local s = os.clock()+2
		local cf1, cf2 = v[4], v[5]
		local attach1, attach2 = v[6], v[7]
		while needed1 == nil and os.clock()<s do
			for ii, vv in ipairs(placed[cf1]:GetDescendants()) do
				if vv:IsA('BasePart') and vv.Name == attachments[ attach1 ] then
					needed1 = vv
					break
				end
			end
			run.RenderStepped:Wait()
		end
		local needed2 = nil
		local s = os.clock()+2
		while needed2 == nil and os.clock()<s do
			for ii, vv in ipairs(placed[cf2]:GetDescendants()) do
				if vv:IsA('BasePart') and vv.Name == attachments[ attach2 ] then
					needed2 = vv
					break
				end
			end
			run.RenderStepped:Wait()
		end
		remote:FireServer(
			name
			,{
				[1]={ ['CFrame'] = needed1.CFrame, SnapPart = needed1 };
				[2]= { ['CFrame'] = needed2.CFrame, SnapPart = needed2 };
			}
		)
	elseif placeMode == 3 then
		local needed1 = nil
		local s = os.clock()+2
		local cf, basepart, attahment = v[2] , v[4], v[5]
		local attach1
		while needed1 == nil and os.clock()<s do
			for ii, vv in ipairs(placed[basepart]:GetDescendants()) do
				if vv:IsA('BasePart') and vv.Name == attachments[ attahment ] then
					needed1 = vv
					break
				end
			end
			run.RenderStepped:Wait()
		end
		remote:FireServer(
			name
			,{
				[1]={ ['CFrame'] = needed1.CFrame; SnapPart = needed1 };
				[2]= { ['CFrame'] = cf, BasePart = base };
			}
		)
	elseif placeMode == 4 then -- new pipe base to base
		remote:FireServer(
			name
			,{
				{CFrame = v[2], BasePart = base},
				{CFrame = v[4], BasePart = base}
			}
		)
	elseif placeMode == 5 then -- new pipe from smth to land
		local s = os.clock()+2
		local cf1 = v[2]
		local basepart = v[5]
		local attachindex = v[4]
		local stoploop = false
		while not stoploop and os.clock()<s do
			for ii, vv in ipairs(placed[basepart]:GetDescendants()) do
				if vv:IsA('BasePart') and vv.Name == attachments[ attachindex ] then
					attachindex = vv
					stoploop = true
					break
				end
			end
			run.RenderStepped:Wait()
		end

		remote:FireServer(
			name, 
			{
				{CFrame = attachindex.CFrame, SnapPart = attachindex};
				{CFrame = cf1, BasePart = base};
			}
		)
	elseif placeMode == 6 then -- new pipe from snap to snap
		local s = os.clock()+3
		local snap1, attach1, snap2, attach2 = v[4], v[5], v[6], v[7]

		local loop = true
		while loop and os.clock()<s do
			for ii, vv in ipairs(placed[snap1]:GetDescendants()) do
				if vv:IsA('BasePart') and vv.Name == attachments[ attach1 ] then
					attach1 = vv
					loop = false
					break
				end
			end
			run.RenderStepped:Wait()
		end
		loop = true
		while loop and os.clock()<s do
			for ii, vv in ipairs(placed[snap2]:GetDescendants()) do
				if vv:IsA('BasePart') and vv.Name == attachments[ attach2 ] then
					attach2 = vv
					loop = false
					break
				end
			end
			run.RenderStepped:Wait()
		end

		remote:FireServer(
			name, 
			{
				{CFrame = attach1.CFrame, SnapPart = attach1};
				{CFrame = attach2.CFrame, SnapPart = attach2};
			}
		)
	end
end


local a, b = pcall(function()

	local stopped = false

	billboard.StopButton.ZIndex = 1000
	billboard.StopButton.MouseButton1Click:Connect(function()
		stopped = true
	end)

	for i, v in ipairs(tbl) do
		if stopped == true then break end

		local name = names[v[1]]
		local send = os.clock() + 60*4
		local partstart = os.clock()
		local tries = 0

		local found = false

		local con = structures.ChildAdded:Connect(function(nig)
			local model = nig
			local builder
			for iii = 1, 20 do
				builder = model:GetAttribute('Builder')
				if not builder then
					task.wait(iii<15 and 0.01 or .25)
				else
					break
				end
			end
			if model.Name == name and builder and (builder == lplr.Name or builder == lplr.DisplayName ) then
				local ss = os.clock()+5
				while ss>os.clock() and model.PrimaryPart == nil do run.RenderStepped:Wait() end
				for aboba = 0, 1, 0.2 do

					if not workspace:IsAncestorOf(model) then return end
					
					local modelPos = partsToFind[name] ~= nil and model:WaitForChild(partsToFind[name], 5).Position or (model.PrimaryPart and model.PrimaryPart.CFrame or (model:FindFirstChildOfClass('Part') or model:FindFirstChildOfClass('MeshPart')).CFrame ).Position

					if isInsideBrick(modelPos) then
						found = model
						break
					else
						if aboba<0.6 then
							run.RenderStepped:Wait()
						else
							task.wait( math.random(20, 40)/100 )
						end
					end
				end
				if found == false then
					warn(model, 'didnt match')
				end
				
			end
		end)

		coroutine.wrap(function()
			while found == false and os.clock()<send and tries<15/.2 and not stopped do
				tries += 1
				billboard.Structure.TextLabel.Text = name..' '..math.round( os.clock()-partstart )..'s'
				placeStructure(i, v, tries)
				task.wait(.2)
			end
		end)()

		repeat run.RenderStepped:Wait() until found~=false or os.clock()>send
		con:Disconnect()
		if found then
			placed[i] = found
			enableShield(found)
		end
		
		if os.clock()>send then
			warn(i, v[i], 'failed')
			break
		end

	end
end)



p:Destroy()
billboard:Destroy()

print(a, b)



